{% extends "base.html" %}
{% block content %}
<!-- Mobile Header -->
<div class="mobile-header">
  <h4 class="mb-0">WebAnalyzer Pro</h4>
  <button class="btn btn-outline-primary" type="button" id="sidebarToggle">
    <i class="fas fa-bars"></i>
  </button>
</div>

<div class="dashboard-layout">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-wave-square"></i> WebAnalyzer Pro
    
    <div class="sidebar-sticky pt-3">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="{{ url_for('dashboard') }}">
            <i class="fas fa-search"></i> New Analysis
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="fas fa-history"></i> Task History
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('check_task') }}">
            <i class="fas fa-check-circle"></i> Check by Task ID
          </a>
        </li>
        <li class="nav-item mt-auto">
          <a class="nav-link text-danger" href="{{ url_for('logout') }}">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main role="main" class="px-4">
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Website Analysis</h4>
        <form method="POST">
          <div class="mb-3">
            <label for="urlInput" class="form-label">Enter URL</label>
            <div class="input-group">
              <input name="url" id="urlInput" class="form-control" type="text" placeholder="https://example.com" required>
              <button type="submit" class="btn btn-primary">Analyze</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Previous Tasks</h4>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>URL</th>
                <th>Status</th>
                <th>Title</th>
                <th>Response Time</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for tarea in tareas %}
              <tr id="task-{{ tarea.task_id }}" data-task-id="{{ tarea.task_id }}">
                <td>{{ tarea.url }}</td>
                <td class="status-cell">
                  {% if tarea.status == 'done' %}
                    <span class="text-success status-icon"><i class="fas fa-check-circle"></i> Completed</span>
                  {% elif tarea.status == 'pending' %}
                    <span class="text-warning status-icon" data-status="pending"><i class="fas fa-clock"></i> Pending</span>
                  {% else %}
                    <span class="text-danger status-icon"><i class="fas fa-exclamation-circle"></i> Failed</span>
                  {% endif %}
                </td>
                <td class="title-cell">{{ tarea.result.title if tarea.result and tarea.result.title else 'N/A' }}</td>
                <td class="time-cell">{{ "%.2fms"|format(tarea.result.time * 1000) if tarea.result and tarea.result.time else 'N/A' }}</td>
                <td class="details-cell">
                  {% if tarea.status == 'done' %}
                    <a class="btn btn-sm btn-outline-info" href="{{ url_for('resultado', task_id=tarea.task_id) }}">
                      <i class="fas fa-info-circle"></i> View
                    </a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.querySelector('.sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    let pollingInterval;

    function updateTaskRow(taskId, result) {
      const taskRow = document.getElementById(`task-${taskId}`);
      if (!taskRow) return;

      // Update Status
      const statusCell = taskRow.querySelector('.status-cell');
      statusCell.innerHTML = `<span class="text-success status-icon"><i class="fas fa-check-circle"></i> Completed</span>`;

      // Update Title
      const titleCell = taskRow.querySelector('.title-cell');
      titleCell.textContent = result.title || 'N/A';

      // Update Time
      const timeCell = taskRow.querySelector('.time-cell');
      timeCell.textContent = result.time ? `${(result.time * 1000).toFixed(2)}ms` : 'N/A';

      // Update Details Button
      const detailsCell = taskRow.querySelector('.details-cell');
      const viewUrl = "{{ url_for('resultado', task_id='TASK_ID_PLACEHOLDER') }}".replace('TASK_ID_PLACEHOLDER', taskId);
      detailsCell.innerHTML = `<a class="btn btn-sm btn-outline-info" href="${viewUrl}"><i class="fas fa-info-circle"></i> View</a>`;
    }

    function pollTaskStatus() {
      const pendingTasks = document.querySelectorAll('[data-status="pending"]');
      const taskIds = Array.from(pendingTasks).map(el => el.closest('tr').dataset.taskId);

      if (taskIds.length === 0) {
        console.log("No more pending tasks. Stopping polling.");
        clearInterval(pollingInterval);
        return;
      }

      console.log("Polling for tasks:", taskIds);

      fetch("{{ url_for('tasks_status') }}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ task_ids: taskIds }),
      })
      .then(response => response.json())
      .then(data => {
        for (const taskId in data) {
          console.log(`Task ${taskId} is complete.`);
          updateTaskRow(taskId, data[taskId]);
        }
      })
      .catch(error => console.error('Error polling for task status:', error));
    }

    function startPolling() {
      const pendingTasks = document.querySelectorAll('[data-status="pending"]');
      if (pendingTasks.length > 0) {
        console.log("Pending tasks found. Starting polling every 5 seconds.");
        // Clear any existing interval just in case
        if (pollingInterval) clearInterval(pollingInterval);
        // Poll immediately and then start the interval
        pollTaskStatus();
        pollingInterval = setInterval(pollTaskStatus, 5000);
      } else {
        console.log("No pending tasks found on page load.");
      }
    }

    // For sidebar toggle
    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('show');
      });
    }

    // Start the polling process
    startPolling();
  });
</script>
{% endblock %}